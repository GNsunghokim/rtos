#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>

#include <net/checksum.h>
#include <byteswap.h>

/** 
 * Sample_packet for data of checksum parameter
 * 192.168.10.101 > 192.168.10.111: ICMP echo reply, id 31419, seq 14, length 64 
 */ 
uint8_t sample_packet[] = { 
	0x10, 0xc3, 0x7b, 0x93, 0x09, 0xd1, 0x74, 0xd4, 
	0x35, 0x8f, 0x66, 0xbb, 0x08, 0x00, 0x45, 0x00,  
	0x00, 0x54, 0x48, 0xe9, 0x00, 0x00, 0x40, 0x01, 
	0x9b, 0x9b, 0xc0, 0xa8, 0x0a, 0x65, 0xc0, 0xa8, 
	0x0a, 0x6f, 0x00, 0x00, 0x58, 0x1d, 0x7a, 0xbb, 
	0x00, 0x0e, 0x08, 0x32, 0xc9, 0x57, 0x00, 0x00, 
	0x00, 0x00, 0x97, 0xbc, 0x05, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 
	0x16, 0x17, 0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 
	0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 
	0x26, 0x27, 0x28, 0x29, 0x2a, 0x2b, 0x2c, 0x2d, 
	0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 
	0x36, 0x37 
}; 

/** 
 * The function 'checksum_rtc1071' is the example code of rtc1071 document(txt).
 */
static uint16_t checksum_rtc1071(uint16_t* addr, uint32_t count) {
	/** 
	 * Compute Internet Checksum for "count" bytes
	 * beginning at location "addr".
	 */
	uint32_t sum = 0;

	while( count > 1 )  {
		/*  This is the inner loop */
		sum += *addr++;
		count -= 2;
	}

	/*  Add left-over byte, if any */
	if( count > 0 )
		sum += *addr;

	/*  Fold 32-bit sum to 16 bits */
	while(sum >> 16) 
		sum = (sum >> 16) + (sum & 0xFFFF);

	return (uint16_t)~sum;
}

static void checksum_func(void** state) {
	uint16_t rtn = checksum((uint16_t*)sample_packet, sizeof(sample_packet));
	uint16_t comp_rtn = checksum_rtc1071((uint16_t*)sample_packet, sizeof(sample_packet));

	assert_int_equal(rtn, bswap_16(comp_rtn));
}

int main(void) {
	const struct CMUnitTest UnitTest[] = {
		cmocka_unit_test(checksum_func),
	};
	return cmocka_run_group_tests(UnitTest, NULL, NULL);
}
